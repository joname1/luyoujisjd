<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="HandheldFriendly" content="true" />
		<meta name="MobileOptimized" content="320" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/iconfont.css">
		<link rel="stylesheet" href="css/common.css">
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ylg8yBCSUPFnuu82sDnIbZ5H"></script>
		<!--<link href="http://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">-->
		<script type="text/javascript" src="js/request_url.js"></script>
		<style>
			html,
			body {
				width: 100%;
				height: 100%;
				background: #fff;
			}
			
			.mui-bar-tab .mui-tab-item {
				color: #555555;
				vertical-align: bottom;
				padding-bottom: 10px;
				height: 80px;
			}
			
			.mui-bar-tab .mui-tab-item.mui-active {
				color: #555555;
			}
			
			#map {
				
				text-align: center;
				position: absolute;
				top: 0px;
				bottom: 100px;
				width: 100%;
			}
			
			.mui-bar-tab .mui-tab-item .mui-icon ~ .mui-tab-label {
				font-size: 14px;
			}
			
			#map_result_div {
				position: absolute;
				width: 100%;
				text-align: center;
				top: 35%;
				vertical-align: middle;
			}
			
			#map_result {
				width: auto;
				display: inline-block;
				height: 11%;
				max-width: 90%;
				line-height: 25px;
				text-align: center;
				margin: 0 auto; 
				top: 35%;
				left: 10%;
				border: 1px solid #ccc;
				padding: 8px;
				background: #FFFFFF;
				vertical-align: middle;
				border-radius: 5px;
				color: #666;
				font-size: 12px;
			}
			 
			#map_result_img {
				width: 80%;
				height: 8%;
				text-align: center;
				top: 45%;
				left: 10%;
				padding: 8px;
				vertical-align: middle;
				border-radius: 5px;
				color: #666;
				font-size: 12px;
			}
			.bar_transparent{ background: #D2D2D2 !important; border-radius: 0 !important;}
			#order_div_1,#order_div_2,#order_div_3,#order_div_4{ display: none;}
			#order_div_2,#order_div_3,#order_div_4{padding-top: 6px;}
			#order_div_3>div,#order_div_4>div{width:100%; text-align: center; line-height: 23px;}
			#order_div_2>div>botton,#order_div_3>div>botton,#order_div_4>div>botton{line-height: 40px; padding: 6px 20px; background: #FF0066; color: #fff;border-radius: 5px; }			
			#order_div_2>div>img{ width: 28px;margin-left: 15px;}
			#order_div_2>div,#order_div_3>div,#order_div_4>div{width:100%; text-align: center; line-height: 46px;}
				.mui-bar-tab{height: 150px;}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="person_center" class="mui-icon mui-pull-left my-bar-nav">
				<img src="img/index_left_fresh_manual.png" />
				<span>个人中心</span>
			</a>
			<a id="pop_adv" class="mui-icon mui-pull-right my-bar-nav">
				<img src="img/icon_lw_blue.png" />
				<span>订单</span>
			</a>
			<h1 class="mui-title">
			   <span>路邮寄·司机端</span>	
			</h1>
		</header>
		
	<!-- AD BANNER-->
	<div class="ad mui-slider" style="margin-top: 50px;">
	  <div class="mui-slider-group mui-slider-loop">
	    	<div class="mui-slider-item mui-slider-item-duplicate">
	    		<a href="http://b00d.cn/dl/jp/ad1.html"><img src="http://mytv-10005639.file.myqcloud.com/ad1.jpg" /></a></div>
	    	<div class="mui-slider-item">
	    		<a href="http://b00d.cn/dl/jp/ad2.html"><img src="http://mytv-10005639.file.myqcloud.com/ad2.jpg" /></a></div>
	    	<div class="mui-slider-item">
	    		<a href="http://b00d.cn/dl/jp/ad3.html"><img src="http://mytv-10005639.file.myqcloud.com/ad3.jpg" /></a></div>
	    	<div class="mui-slider-item">
	    		<a href="http://b00d.cn/dl/jp/ad4.html"><img src="http://mytv-10005639.file.myqcloud.com/ad4.jpg" /></a></div>
 	    	<div class="mui-slider-item mui-slider-item-duplicate">
	    		<a href="http://b00d.cn/dl/jp/ad1.html"><img src="http://mytv-10005639.file.myqcloud.com/ad1.jpg" /></a></div>  
	  </div>
	</div>
	<div class="ad mui-slider" style="">
	  <div class="mui-slider-group mui-slider-loop">
	    	<div class="mui-slider-item mui-slider-item-duplicate">
	    		<a href="http://b00d.cn/dl/jp/ad1.html"><img src="http://mytv-10005639.file.myqcloud.com/ad1.jpg" /></a></div>
	    	<div class="mui-slider-item">
	    		<a href="http://b00d.cn/dl/jp/ad2.html"><img src="http://mytv-10005639.file.myqcloud.com/ad2.jpg" /></a></div>
	    	<div class="mui-slider-item">
	    		<a href="http://b00d.cn/dl/jp/ad3.html"><img src="http://mytv-10005639.file.myqcloud.com/ad3.jpg" /></a></div>
	    	<div class="mui-slider-item">
	    		<a href="http://b00d.cn/dl/jp/ad4.html"><img src="http://mytv-10005639.file.myqcloud.com/ad4.jpg" /></a></div>
 	    	<div class="mui-slider-item mui-slider-item-duplicate">
	    		<a href="http://b00d.cn/dl/jp/ad1.html"><img src="http://mytv-10005639.file.myqcloud.com/ad1.jpg" /></a></div>  
	  </div>
	</div>
	<script>
		var gallery = mui('.mui-slider');
		gallery.slider({
		  interval:4000//自动轮播周期，若为0则不自动播放，默认为0；
		});
	</script>
	<div class="mui-content" style="background:#fff!important">
			<nav class="mui-bar-tab bar_transparent" id="order_div_1" style="height:160px;text-align:center;background:#fff!important">
				<!--<a class="mui-tab-item" id="date_car">
					<span class="mui-icon iconfont icon-yuyue"></span>
					<span class="mui-tab-label">抢单</span>
				</a>-->

			<a class="mui-tab-item" id="date_car">
				<!-- <img src="img/btns.png" style="height:110px;width:110px;"> -->
				<button class="mui-tab-label mui-btn" style="background-color:#de8d1a;color:white;">进入待抢订单</button>
			</a>
			</br>
			<h5>Copyright <i class="fa fa-copyright"></i> 2016 易伙三商科技有限公司</h5>
		</nav>
			</nav>
			<nav class="mui-bar-tab bar_transparent" id="order_div_2">
				
				<div>正在前往<img align="absmiddle" id="user_tel" src="img/telephone_icon@2x_09.png"></div>			
				<div>
					<botton id="up_car">已收货</botton>
				</div>
			</nav>
			<nav class="mui-bar-tab bar_transparent" id="order_div_3">
				 <!--style="display: block!important"-->
				<div>
				送货中
				<!--	已行驶<span id="al_away">0</span>公里，<span id="al_fee">0</span>元  -->
					<br />
					<botton id="user_tel2"><img align="absmiddle" src="img/telephone_icon@2x_09.png" width="24px">发货人</botton>
					<botton id="user_tel3"><img align="absmiddle" src="img/telephone_icon@2x_09.png" width="24px">收货人</botton>
				</div>	
				<div>
					<botton id="go_to">已送达</botton>
				</div>
			</nav>
			<style type="text/css">
				.hidden{height: 1px;overflow: hidden;}
			</style>
			<nav class="mui-bar-tab bar_transparent" id="order_div_4">
				<div class="hidden">共行驶<span id="g_away">0</span>公里，等待支付<span id="g_fee">0</span>元</div>	
				<div>请选择支付方式</div>
				<div>
					<botton id="confirm_pay">司机代付</botton>
					<botton id="confirm_pay1">收货方支付</botton>
					<botton id="confirm_pay2">发货方支付</botton>
				</div>
			</nav>		
			<div id="map" style="display: none;">地图加载中...</div> 
			<div align="center" id="map_result_div">
				<!--<div id="map_result">正在获取地址...</div>-->
			</div>
		</div>
		<!--<div id="map_result_img" style="position: absolute;bottom: 50px;">
			<img src="img/markers.png" style="width: 20px;height: 30px;" />
		</div>-->
		<div id="back_current_position" style="display: none;position: absolute;bottom: 100px;">
			<img src="img/iconfont-wujiaoxing.png" width="40px" />
		</div>
		</div>

		<!-- 弹出框广告信息-->
			<style>
						#qrpay{    border: solid 1px #bbb;
    border-radius: 5px;
    margin: 50px auto;
    width:300px;
    height: auto;
    text-align: center;
    background-color: #fff;}
    #qr-close{margin: auto;font-size:60px;color: #666;}
					</style>
		<div id="pop_div" class="bar_transparent" style="width: 100%;height: 100%;display:none;text-align: center;top:0">
					<div id="qrpay">
						<iframe frameborder="0" id="qrurl" style="height: 300px;"></iframe>
						
					</div>
					请收货方微信扫描上方二维码支付
					<br /><br />
					<div onclick="document.getElementById('pop_div').style.display='none'" class="mui-btn mui-btn-danger mui-btn-outlined">关闭</div>
					<!--<a id="qr-close" class=""><span class="mui-icon mui-icon-close-filled"></span></a>-->
				
		</div>

	</body>

	<script>
	console.log('ddd');
		var menu = null,
			main = null;
		var showMenu = false;
		var islogin = 0;
		mui.init();
		var isInTransition = false;
		//点击左上角侧滑图标，打开侧滑菜单；
		document.getElementById("person_center").addEventListener('tap', function(e) {			
			islogin = plus.storage.getItem('isServerlogin');
			islogin = 1;//测试用
			/*判空操作*/
			if (islogin == null) {
				plus.storage.setItem('isServerlogin', 0);
			}
			console.log("islogin0====" + islogin);
			if ((islogin != 1) || (islogin != "1")) {
				mui.openWindow({
					id: "login",
					url: "login/login.html"
				});
			} else {
				mui.openWindow({
					id: "setting_menu",
					url: "setting_menu.html"
				});
			}
		});
		//首页返回键处理
		//处理逻辑：1秒内，连续两次按返回键，则退出应用；
		var first = null;
		mui.back = function() {
			if (showMenu) {
				closeMenu();
			} else {
				//首次按键，提示‘再按一次退出应用’
				if (!first) {
					first = new Date().getTime();
					mui.toast('再按一次退出应用');
					setTimeout(function() {
						first = null;
					}, 1000);
				} else {
					if (new Date().getTime() - first < 1000) {
						plus.runtime.quit();
					}
				}
			}
		};
	</script> 

	<script type="text/javascript">
		var coachLatPosArr = "";
		var coachLongtPosArr = "";
		var coachOrderPkArr = "";
		var order_typeArr = ""; //保存预定类型 立即叫车 1 预约 2半日租 3日租
		var user_telArr = ""; //用户电话
		var order_datetimeArr = ""; //用车时间
		var start_addressArr = ""; //上车地址
		var end_addressArr = ""; //下车地址
		var logincoach_pk = "";
		var isserverlog = 0;
		var strParam = "";
		var preMarker = new Array();	
		var up_car_point=null;		
		mui.plusReady(function() {			
			if(parseFloat(plus.storage.getItem('isServerlogin') || 0)!=1)
			{
				mui.openWindow({
					id: "login",
					url: "login/login.html"
				});
			}
			

			//检查更新	
//			plus.runtime.getProperty( plus.runtime.appid, function ( wgtinfo ) {					
//				mui.ajax(request_url + "get_update", {	
//					data: {
//						"_type":2,
//						"version": wgtinfo.version
//					},
//					dataType: 'json', //服务器返回json格式数据
//					type: 'post', //HTTP请求类型
//					timeout: 5000, //超时时间设置为5秒； 
//					success: function(rsp) {	
//						console.log(JSON.stringify(rsp));
//						if(parseInt(rsp.result)==100) 
//						{
//							 var btnArray = ['更新', '取消'];
//							mui.confirm('系统有更新，立即更新？', '系统提示', btnArray, function(e) {
//								if (e.index == 0) {
//									plus.runtime.openURL(request_img_url+"down_ser.aspx");									
//								} 
//							});
//						}						
//					}
//				});				
//			});
			//获取司机订单信息
			get_coach_order_info();
			/*调用初始化定位信息*/
			getPosBaidu();
			post_coach_info();
			plus.storage.setItem("shouche", "false");
			var geoc = new BMap.Geocoder();
			var point2 = new BMap.Point(108.93, 34.27); // 创建点坐标
			map = new BMap.Map("map"); // 创建地图实例
			map.centerAndZoom(point2, 20); // 初始化地图，设置中心点坐标和地图级别
			map.addControl(new BMap.NavigationControl());
			logincoach_pk = plus.storage.getItem("logincoach_pk");
			// 编写自定义函数,创建标注
			get_clientorder_list(); //获取客户订单信息
			function getPosition() {
				var mPoint = map.getCenter();
				var lat = mPoint.lat; //获取到当前位置的纬度；			
				var longt = mPoint.lng; //获取到当前位置的经度
				var url = "http://api.map.baidu.com/geocoder/v2/?ak=FC9c13967bf240823ed03d702d883e83&location=" + lat + "," + longt + "&output=json&pois=1"
				mui.getJSON(url, function(rsp) {
					if (rsp != null) {
						console.log(JSON.stringify(rsp));
						var addComp = rsp.result.addressComponent;
						var currentStreet = addComp.district + addComp.street;
						var currentPosition = rsp.result.sematic_description;
						console.log(currentPosition);
						if (currentPosition != "") {
							document.getElementById("map_result").innerHTML = currentStreet + "<br/>" + currentPosition;
							plus.storage.setItem("start_postion", currentStreet + currentPosition);
						} else {
							document.getElementById("map_result").innerHTML = currentStreet;
							plus.storage.setItem("start_postion", currentStreet);
						}
					}
				});
			}
			//			//开始移动地图
			//			map.addEventListener("dragstart", function(e) {
			//				document.getElementById("map_result_div").style.display = "none";
			//			});
			//			//移动地图结束
			//			map.addEventListener("dragend", function(e) {
			//				//getPosition();
			//				document.getElementById("map_result_div").style.display = "";
			//			});
			/*点击显示隐藏广告框信息*/
			var pop_adv = document.getElementById("pop_adv");
			var pop_div = document.getElementById("pop_div");
//			if (pop_div.style.display != "none") {
//				defaultShowSlide();
//			}
			pop_adv.addEventListener("tap", function() {	
				mui.openWindow({
					id: "ordermanager",
					url: "usercenter/ordermanager.html"
				});	
//				if (pop_div.style.display == "none") {
//					pop_div.style.display = "";
//					defaultShowSlide();
//				} else {
//					pop_div.style.display = "none";
//				} 
			})
			plus.push.setAutoNotification(true);
			console.log('dddsss');
			var info = plus.push.getClientInfo();
			console.log("获取客户端推送标识信息：");
			console.log("token: " + info.token);
			console.log("clientid: " + info.clientid); 
			console.log("appid: " + info.appid);
			console.log("appkey: " + info.appkey);
			plus.storage.setItem("clientid", info.clientid);
			plus.storage.setItem("appid", info.appid);
			plus.storage.setItem("appkey", info.appkey);
			plus.storage.setItem("token", info.token);  
			plus.push.addEventListener("click", function(msg) {
				// 判断是从本地创建还是离线推送的消息
				switch (msg.payload) {
					case "LocalMSG":
						outSet("点击本地创建消息启动：");
						break;
					default:
						outSet("点击离线推送消息启动：");
						break;
				}
				// 处理其它数据
				logoutPushMsg(msg);
			}, false);
			// 监听在线消息事件
			plus.push.addEventListener("receive", function(msg) {
				if (msg.aps) { // Apple APNS message
										mui.toast("接收到在线APNS消息：");
										console.log("接收到在线APNS消息：");
				} else {
										mui.toast("接收到在线透传消息：");
										console.log("接收到在线透传消息：");
				}
				if(plus.storage.getItem("JIEDIAN")!="1")//接单模式关闭  0为打开， 1为关闭
				{
					logoutPushMsg(msg);
					console.log('111 接单模式');
				}else{
					//logoutPushMsg(msg);  原无
					console.log('000 接单模式 关闭');
				}
			}, false);
			
			
			/**
 * 本地创建一条推动消息
 */
//function createLocalPushMsg(){
//	var options = {cover:false};
//	var str = dateToStr(new Date());
//	str += ": 欢迎使用HTML5+创建本地消息！";
//	alert('dd');
//	plus.push.createMessage( str, "LocalMSG", options );
//	console.log( "创建本地消息成功！" );
//	console.log( "请到系统消息中心查看！" );
//	if(plus.os.name=="iOS"){
//		outLine('*如果无法创建消息，请到"设置"->"通知"中配置应用在通知中心显示!');
//	}
//}
//createLocalPushMsg();

			/**
			 * 日志输入推送消息内容
			 */
			function logoutPushMsg(msg) {
				if (msg.payload) {
					plus.storage.setItem("payload", msg.payload);
					var shouche = plus.storage.getItem("shouche");
					isserverlog = plus.storage.getItem('isServerlogin');
				//	isserverlog =1;//测试用
					/*判空操作*/
					if (isserverlog == null) {
						plus.storage.setItem('isServerlogin', 0);
					}
					if ((isserverlog != 1) || (isserverlog != "1")) {
					} else {
						// 查找最新订单并弹出 START
						var url = request_url + "get_lastest_order";
						mui.ajax(url,{
							dataType: 'json',
							type: 'post',
							timeout: 5000,
							success: function(response){
								var s = '{"Table": ['+JSON.stringify(response.Table[0])+']}';
									console.log(response.Table[0]);
									qiangdan(s);
								},
									error: function(xhr, type, errorThrown){
										console.log("\n失败$$$$$" + xhr.status + "$$$" + type +"$$$" + errorThrown);
									}
						});
						// 查找最新订单并弹出 END

						// mui.openWindow({ 
						// 	id: "qiangdan",
						// 	url: "qiangdan.html",
						// 	extras: {
						// 		param: msg.payload
						// 	}
						// });						
					}
					console.log(msg.payload);
				} else {
					console.log("payload: undefined");
				}
				if (msg.aps) {
					console.log("aps: " + JSON.stringify(msg.aps));
				}
			}		
			document.getElementById("user_tel").addEventListener("tap", function() {
				var user_tel=document.getElementById("user_tel").getAttribute("user_tel");
				plus.device.dial(user_tel, true);
					});
			document.getElementById("user_tel2").addEventListener("tap", function() {
				var user_tel=document.getElementById("user_tel").getAttribute("user_tel");
				plus.device.dial(user_tel, true);
					});
			document.getElementById("user_tel3").addEventListener("tap", function() {
				var receive_tel=document.getElementById("user_tel").getAttribute("receive_tel");
				alert(receive_tel);
				plus.device.dial(receive_tel, true);
			});
			//用户上车
			document.getElementById("up_car").addEventListener("tap", function() {				
				plus.nativeUI.confirm("确定货物已上车吗？", function(e) {
					if (e.index == 0) {
						var coach_pk = plus.storage.getItem('logincoach_pk');
						var order_pk=document.getElementById("up_car").getAttribute("order_pk");
						var url = request_url + "up_car";
						mui.ajax(url, {
							data: {							
								"order_pk": order_pk
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 5000, //超时时间设置为10秒；
							success: function(response) {	
								if (response.result == 100){										
									get_coach_order_info();
								}
								else {
									mui.toast("服务器处理异常!");
								} 
							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
							}
						});	
					}
				}, "提示");				
			});
			//已到达
			document.getElementById("go_to").addEventListener("tap", function() {				
				plus.nativeUI.confirm("确定已达到目的地？", function(e) {
					if (e.index == 0) {
						var coach_pk = plus.storage.getItem('logincoach_pk');
						var order_pk=document.getElementById("go_to").getAttribute("order_pk");
						var url = request_url + "go_to";
						mui.ajax(url, {
							data: {							
								"order_pk": order_pk
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 5000, //超时时间设置为10秒；
							success: function(response) {	
								if (response.result == 100){	
									up_car_point=null;
									get_coach_order_info();
								}
								else {
									mui.toast("服务器处理异常!");
								} 
							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
							}
						});	
					}
				}, "提示");				
			});
			//余额支付
			document.getElementById("confirm_pay").addEventListener("tap", function() {				
				plus.nativeUI.confirm("将使用您的余额支付,确定用户已付款？", function(e) {
					if (e.index == 0) {						
						var order_pk=document.getElementById("confirm_pay").getAttribute("order_pk");
						var coach_pk=document.getElementById("confirm_pay").getAttribute("logincoach_pk");
						//var url = request_url + "confirm_pay";
						var url = request_url + "confirm_pay&user_pk="+plus.storage.getItem('logincoach_pk')+"&money="+document.getElementById("g_fee").textContent;
						mui.ajax(url, {
							data: {							
								"order_pk": order_pk
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 5000, //超时时间设置为10秒；
							success: function(response) {	
								console.log(response.result);
								if (response.result == 100){	
									updateOrder(order_pk,4);
									get_coach_order_info();
									mui.toast("余额支付成功!");
								}else if(response.result == -99){
									mui.toast("余额不足!");
								}
								else {
									mui.toast("服务器处理异常!");
								} 
							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
							}
						});	
					}
				}, "提示");				
			});
			
			function updateOrder(order_pk,status){
				var url = request_url + "update_order2";
						mui.ajax(url, {
							data: {							
								"order_pk": order_pk,		
								"status": status
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 5000, //超时时间设置为10秒；
							success: function(response) {	
								
							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
							}
						});	
			}
			//二维码支付
			document.getElementById("confirm_pay1").addEventListener("tap", function() {				
//				mui.toast("二维码支付未开通!");
				order_pk=document.getElementById("confirm_pay").getAttribute("order_pk");
//				var order_fee = plus.storage.getItem("order_fee");
				var order_fee = document.getElementById("g_fee").textContent;
				console.log(order_fee);
				document.getElementById("qrurl").src = "http://wqq2.xyj0772.com/wxpay/example/native.php?order_pk="+order_pk+"&fee="+order_fee;
				document.getElementById("pop_div").style.display = "block";
	
			});
			
			//用户支付
			document.getElementById("confirm_pay2").addEventListener("tap", function() {				
				plus.nativeUI.confirm("货物已送达,将账单发送给用户？", function(e) {
					if (e.index == 0) {						
						var order_pk=document.getElementById("confirm_pay").getAttribute("order_pk");
						
						var url = request_url + "update_order";
						mui.ajax(url, {
							data: {							
								"order_pk": order_pk
							},
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							timeout: 5000, //超时时间设置为10秒；
							success: function(response) {	
								console.log(response.result);
								if (response.result == 1){										
									get_coach_order_info();
									mui.toast("订单已成功!");
								}
								else {
									mui.toast("服务器处理异常!");
								} 
							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
							}
						});	
					}
				}, "提示");				
			});
			//setTimeout("qiangdan()",1000*5)
		});
		
		
			
		
		function qiangdan(s){

			mui.openWindow({
				id: "qiangdan",
				url: "qiangdan.html",
				extras: {
					param: s
				}
			});
		}
		function get_coach_order_info()
		{	//已接订单状态刷新
			
//			get_clientorder_list();//获得最新订单
			setTimeout("get_coach_order_info()","5000");	
			var coach_pk = plus.storage.getItem('logincoach_pk');		
			var url = request_url + "get_coach_order_info";
			mui.ajax(url, {
				data: {
					"coach_pk":coach_pk
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 5000, //超时时间设置为10秒；
				success: function(response) {	
//					 console.log("get_coach_order_info() 已接订单状态刷新"+response.Table[0].order_state);
					if(response.Table.length>0)
					{
						if(response.Table[0].order_state=="1")
						{
							nav_info();
							document.getElementById("map").style.display="block";	
							document.getElementById("order_div_2").style.display="block";						
							document.getElementById("user_tel").setAttribute("user_tel",response.Table[0].user_tel);	
							document.getElementById("user_tel").setAttribute("receive_tel",response.Table[0].receive_tel);	
							document.getElementById("up_car").setAttribute("order_pk",response.Table[0].order_pk);							
							go_start(response);
						}
						else if(response.Table[0].order_state=="2") 
						{
							nav_info();
							up_car_point=new BMap.Point(response.Table[0].start_lon,response.Table[0].start_lat);	
//							GetAwayAndTime();
//							GetOrderFee();
							document.getElementById("order_div_3").style.display="block";
							document.getElementById("go_to").setAttribute("order_pk",response.Table[0].order_pk);
							go_end(response);							
						}
						else if(response.Table[0].order_state=="3")
						{
							nav_info();
							document.getElementById("order_div_4").style.display="block";						
							document.getElementById("g_away").textContent=parseFloat(response.Table[0].order_away || 0);
							document.getElementById("g_fee").textContent=parseFloat(response.Table[0].order_fee || 0);	
							document.getElementById("confirm_pay").setAttribute("order_pk",response.Table[0].order_pk);							
//							setTimeout("get_coach_order_info()","2000");							
						}
						else if(response.Table[0].order_state=="0")
						{				
							qiangdan(response.Table[0]);//抢单 
						}
						else
						{							
							map.clearOverlays();
							map.addOverlay(marker); //增加点
							nav_info();
							document.getElementById("order_div_1").style.display="block";
						}
					}
					else {
						map.clearOverlays();
						map.addOverlay(marker); //增加点  
						nav_info();
						document.getElementById("order_div_1").style.display="block";
					}
				}, 
				error: function(xhr, type, errorThrown) {
					//异常处理；
					console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
				}
			});
		}
		window.addEventListener('qiangdan_order', function(event) {
				get_coach_order_info()
		});
		
		function go_start(order)
		{			
			var my_start_lat=order.Table[0].start_lon;
			var my_start_lon=order.Table[0].start_lat;	
			ePoint = new BMap.Point(my_start_lat,my_start_lon);			
			GetLength();
		}
		function go_end(order)
		{			
			var my_end_lat=order.Table[0].end_lon;
			var my_end_lon=order.Table[0].end_lat;			
			ePoint = new BMap.Point(my_end_lat,my_end_lon);			
			GetLength();
		}
		var driving;
		function GetLength() {
			if(mPoint==null)
			{
				start_daohang=true;
				return;
			}
			map.clearOverlays(); 
			map.addOverlay(marker); //增加点
			 driving = new BMap.DrivingRoute(map, {renderOptions:{map: map, autoViewport: true}});		
			driving.search(mPoint, ePoint);
		}
		var searchComplete = function(results) {
			if (transit.getStatus() != BMAP_STATUS_SUCCESS) {
				return;
			}
			var plan = results.getPlan(0);			    
		}
		function nav_info()
		{
			document.getElementById("order_div_1").style.display="none";
			document.getElementById("order_div_2").style.display="none";
			document.getElementById("order_div_3").style.display="none";
			document.getElementById("order_div_4").style.display="none";
		}
		function addMarker(point) {
			//			map.centerAndZoom(point, 15); // 初始化地图，设置中心点坐标和地图级别
			var myIcon = new BMap.Icon("img/peple.png", new BMap.Size(20, 20));
			// 创建标注对象并添加到地图   
			var marker = new BMap.Marker(point, {
				icon: myIcon
			});
			map.addOverlay(marker); //增加点
			preMarker.push(marker);
			marker.addEventListener("click", function() {
				var p = marker.getPosition(); //获取marker的位置
				console.log("coachLatPosArr.length==" + coachLatPosArr.length);
				for (var i = 0; i < coachLatPosArr.length; i++) {
					if ((coachLatPosArr[i] == p.lng && (p.lng != "")) && (coachLongtPosArr[i] == p.lat && (p.lat != ""))) {
						isserverlog = plus.storage.getItem('isServerlogin');
						/*判空操作*/
						if (isserverlog == null) {
							plus.storage.setItem('isServerlogin', 0);
						}
						console.log("isserverlog====" + isserverlog);
						if ((isserverlog != 1) || (isserverlog != "1")) {
							mui.openWindow({
								id: "login",
								url: "login/login.html"
							});
						} else {
							strParam = order_typeArr[i] + "&" + user_telArr[i] + "&" + order_datetimeArr[i] + "&" + start_addressArr[i] + "&" + end_addressArr[i] + "&" + coachOrderPkArr[i] + "&" + logincoach_pk
							mui.openWindow({
								id: "graborder.html",
								url: "usercenter/graborder.html",
								extras: {
									param: strParam
								}
							})
						}
					}
				}
			});
		}
		/*获取客户端提交的订单列表*/
			var tan =0 ;
		function get_clientorder_list() {
			// 清空APP图标的角标
    console.log('设置APP图标的角标');
    plus.runtime.setBadgeNumber('0'); 
			coachLatPosArr = new Array();
			coachLongtPosArr = new Array(); 
			coachOrderPkArr = new Array();
			order_typeArr = new Array();
			user_telArr = new Array();
			order_datetimeArr = new Array();
			start_addressArr = new Array();
			end_addressArr = new Array();
			//初始化，清空数组元素 
			coachLatPosArr.splice(0, coachLatPosArr.length);
			coachLongtPosArr.splice(0, coachLongtPosArr.length);
			coachOrderPkArr.splice(0, coachOrderPkArr.length);
			order_typeArr.splice(0, order_typeArr.length);
			user_telArr.splice(0, user_telArr.length);
			order_datetimeArr.splice(0, order_datetimeArr.length);
			start_addressArr.splice(0, start_addressArr.length);
			end_addressArr.splice(0, end_addressArr.length);
			var url = request_url + "get_order_list";
			var coach_pk = plus.storage.getItem("logincoach_pk");	
			var tan = plus.storage.getItem("tan");	
		
			mui.ajax(url, {
				data: {
					"coach_pk": coach_pk
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 5000, //超时时间设置为5秒；
				success: function(rsp) {
					
					if (preMarker.length > 0) {
						for (var i = 0; i < preMarker.length; i++) {
							map.removeOverlay(preMarker[i]);
						}
						preMarker.length = 0;
					}
					for (var i = 0; i < rsp.Table.length; i++) {
					var s = '{"Table":['+JSON.stringify(rsp.Table[i])+']}';
					console.log(" 最新订单ID:"+rsp.Table[i].orderid + " 已弹:"+ tan + "订单费用："+rsp.Table[i].order_fee);
					
					if(tan < rsp.Table[i].orderid ){ // < 	
						//弹出抢单 
					//	console.log('弹出抢单');
					//	plus.storage.setItem("tan",rsp.Table[i].orderid);	//存入最新ID
					//	qiangdan(s);//抢单
					} 
						coachLatPosArr[i] = rsp.Table[i].start_lat;
						coachLongtPosArr[i] = rsp.Table[i].start_lon;
						coachOrderPkArr[i] = rsp.Table[i].order_pk;
						order_typeArr[i] = rsp.Table[i].order_type;
						user_telArr[i] = rsp.Table[i].user_tel;
						order_datetimeArr[i] = rsp.Table[i].order_datetime;
						start_addressArr[i] = rsp.Table[i].start_address;
						end_addressArr[i] = rsp.Table[i].end_address;
						if (coachLongtPosArr[i] != "") {
							// 在地图中添加订单地址
							addMarker(new BMap.Point(coachLongtPosArr[i], coachLatPosArr[i]));
						}
					}
				},
				error: function(xhr, type, errorThrown) {
					//异常处理；
					console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
				}
			});
			setTimeout("get_clientorder_list()", 10000);
		}
		var First = true;
		var marker;
		var mPoint;
		var ePoint;
		var start_daohang=false;
		var bounds = new Array();
		var linesPoints = new Array();
		var sPoint;
		var myIcon = new BMap.Icon("img/markers.png", new BMap.Size(30, 41));
		/*初始化地图时时定位信息*/
		function geoInf(position) {
			var codns = position.coords; //获取地理坐标信息；
			var lat = codns.latitude; //获取到当前位置的纬度；			
			var longt = codns.longitude; //获取到当前位置的经度
			if (First == false) {
				mPoint = new BMap.Point(longt, lat);
				marker.setPosition(mPoint);
				map.centerAndZoom(mPoint, map.getZoom());
				GetAddress();
				plus.storage.setItem("coach_lon", longt + "");
				plus.storage.setItem("coach_lat", lat + "");
				if(start_daohang){start_daohang=false; GetLength();}				
				return false;
			}
			mPoint = new BMap.Point(longt, lat);
			sPoint = mPoint;
			map.centerAndZoom(mPoint, 20);
			First = false;
			marker = new BMap.Marker(mPoint, {
				icon: myIcon
			});
			GetAddress();
			map.addOverlay(marker); //增加点
			plus.storage.setItem("coach_lon", longt + "");
			plus.storage.setItem("coach_lat", lat + "");
			setTimeout("getPosBaidu()", 20000);
		}

		function GetLabel(x, y, curr_address) {
			var opts = {
				position: mPoint, // 指定文本标注所在的地理位置
				offset: new BMap.Size(x, y) //设置文本偏移量
			}
			var label = new BMap.Label(curr_address, opts); // 创建文本标注对象
			label.setStyle({
				color: "#666",
				fontSize: "12px",
				lineHeight: "25px",
				fontFamily: "Helvetica Neue,Helvetica,sans-serif",
				border: 'solid 1px #ccc',
				display: 'inline-block',
				'border-radius': '5px',
				padding: '8px'
			});
			return label;
		}

		function GetAddress() {
			var url = "http://api.map.baidu.com/geocoder/v2/?ak=FC9c13967bf240823ed03d702d883e83&location=" + mPoint.lat + "," + mPoint.lng + "&output=json&pois=1"
			mui.getJSON(url, function(rsp) {
				if (rsp != null) {
					//console.log(JSON.stringify(rsp));
					var addComp = rsp.result.addressComponent;
					var currentStreet = addComp.street;
					var currentPosition = rsp.result.sematic_description;
					var curr_address = "";
					var x, y;
					if (currentPosition != "") {
						//document.getElementById("map_result").innerHTML = currentStreet + "<br/>" + currentPosition;
						curr_address = currentStreet + "<br/>" + currentPosition;
						x = -currentPosition.length * 5 - 8;
						y = -77;
						plus.storage.setItem("start_postion", currentStreet + currentPosition);
					} else {
						//document.getElementById("map_result").innerHTML = currentStreet;
						curr_address = currentStreet;
						x = -currentStreet * 5 - 8;
						y = -36;
						plus.storage.setItem("start_postion", currentStreet);
					}
					if (First == false) {
						//marker.setPosition(mPoint);
						map.removeOverlay(marker.getLabel());
						marker.setLabel(GetLabel(x, y, curr_address));
						return false;
					}
					marker.setLabel(GetLabel(x, y, curr_address));
				}
			});
		}

		function run() {
			if (linesPoints.length == 0) setTimeout("getPosBaidu()", 20000);
			for (var m = 0; m < linesPoints.length; m++) {
				var pts = linesPoints[m];
				var len = pts.length;
				resetMkPoint(1, len, pts, marker)
			}
		}

		function resetMkPoint(i, len, pts, carMk) {
			map.removeOverlay(marker.getLabel());
			carMk.setPosition(pts[i]);
			map.centerAndZoom(pts[i], map.getZoom());
			if (i < len) {
				setTimeout(function() {
					i++;
					resetMkPoint(i, len, pts, carMk);
				}, (2 / len * 1000));
			} else {
				bounds = new Array();
				linesPoints = new Array();
				GetAddress();
				setTimeout("getPosBaidu()", 20000);
			}
		}

		function drawLine(results) {
			var opacity = 0.01;
			var planObj = results.getPlan(0);
			var b = new Array();
			var addPoints = function(points) {
					for (var i = 0; i < points.length; i++) {
						bounds.push(points[i]);
						b.push(points[i]);
					}
				}
				// 绘制驾车步行线路
			for (var i = 0; i < planObj.getNumRoutes(); i++) {
				var route = planObj.getRoute(i);
				if (route.getDistance(false) <= 0) {
					continue;
				}
				addPoints(route.getPath());
				// 驾车线路
				map.addOverlay(new BMap.Polyline(route.getPath(), {
					strokeColor: "#30a208",
					strokeOpacity: opacity,
					strokeWeight: 6,
					enableMassClear: true
				}));
			}
			//map.setViewport(bounds);
			// 终点
			//addMarkerFun(results.getEnd().point,1,1);
			// 开始点
			//addMarkerFun(results.getStart().point,1,0);
			linesPoints[linesPoints.length] = b;
		}
		// 通过百度定位模块获取位置信息
		function getPosBaidu() {
			plus.geolocation.getCurrentPosition(geoInf, function(e) {
				console.log("info----" + e.message);
			}, {
				provider: 'baidu'
			});
			setTimeout("getPosBaidu()", 20000);
		}
		/*增加首页默认滑动事件*/
		function defaultShowSlide() {
			var gallery = mui("#slider");
			gallery.slider({
				interval: 3000
			});
		};
		/*司机登录后，向后台提交司机的经纬度信息*/
		function post_coach_info() {
			var coach_pk = plus.storage.getItem("logincoach_pk");
			var coach_lon = plus.storage.getItem("coach_lon");
			var coach_lat = plus.storage.getItem("coach_lat");
			
			var url = request_url + "set_coach_place";
			//不为空的情况下，保存经纬度，并提交后台处理
			if (coach_lon != null && coach_lat != null) {
				mui.ajax(url, {
					data: {
						"coach_pk": coach_pk,
						"coach_lon": coach_lon,
						"coach_lat": coach_lat
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 5000, //超时时间设置为5秒；
					success: function(response) {
						//console.log(JSON.stringify(response));
					},
					error: function(xhr, type, errorThrown) {
						//异常处理；
						console.log("\n失败$$$$$" + xhr.status + "$$$" + type + "$$$" + errorThrown);
					}
				});
			}
		//	console.log('更新司机地址');
			setTimeout("post_coach_info()", 6000);
		}
		function GetAwayAndTime()
		{	
			//重新按时间、里程计算
			if(up_car_point!=null) 
			{
				if((mPoint || null)==null ) {
					setTimeout("GetAwayAndTime()", 7000);
					return;
				}
				var away=map.getDistance(up_car_point,mPoint);			
								
				var order_pk=document.getElementById("go_to").getAttribute("order_pk");
				 
				if((order_pk || null)==null ) {
					setTimeout("GetAwayAndTime()", 8000);
					return;
				}
				var url = request_url + "get_order_fee";
				mui.ajax(url, {
					data: {
						"order_pk": order_pk,
						"order_away":away
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 5000, //超时时间设置为5秒；
					success: function(rsp) {						
						setTimeout("GetAwayAndTime()", 9000);
						if(rsp!=null) 
						{
							up_car_point=mPoint;
							document.getElementById("al_away").innerHTML=parseFloat(rsp.Table[0].order_away || 0);
							document.getElementById("al_fee").innerHTML=parseFloat(rsp.Table[0].order_fee || 0);	
							var order_fee = rsp.Table[0].order_fee;
							console.log('订单费用：'+order_fee);
							plus.storage.setItem("order_fee",order_fee);
						}						
					}
				});				
			}
		}
		function GetOrderFee()
		{					
				var order_pk=document.getElementById("go_to").getAttribute("order_pk");
				if((order_pk || null)==null ) {
					setTimeout("GetOrderFee()", 8000);
					return;
				}
				var url = request_url + "get_order_fee2";
				mui.ajax(url, {
					data: {
						"order_pk": order_pk
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 5000, //超时时间设置为5秒；
					success: function(rsp) {					
						if(rsp!=null) 
						{
							up_car_point=mPoint;
							document.getElementById("al_away").innerHTML=parseFloat(rsp.Table[0].order_away || 0);
							document.getElementById("al_fee").innerHTML=parseFloat(rsp.Table[0].order_fee || 0);	
							var order_fee = rsp.Table[0].order_fee;
							console.log('订单费用：'+order_fee);
							plus.storage.setItem("order_fee",order_fee);
						}						
					}
				});		
		}
		/*回到当前位置点击事件 */
		var back_current_position = document.getElementById("back_current_position");
		back_current_position.addEventListener("tap", function() {
			getPosBaidu();
		});
		var date_car = document.getElementById("date_car");
		
		date_car.addEventListener("tap", function() {
			
			isserverlog = plus.storage.getItem('isServerlogin');
			var state = plus.storage.getItem("coach_state"); 
			isserverlog = 1;//测试用
			
			if(state =="0"){
					plus.nativeUI.confirm("您的资料尚审核中，无法接单！\n‘取消’等待审核  ‘确定’修改资料", function(e) {
				if (e.index == 0) { 
					mui.openWindow({
								id: "reg",
								url: "login/reg_info.html"
							});
				}
				})
				return false;
			}else if(state =="" || state == null){
				plus.nativeUI.confirm("请先完善个人资料！", function(e) {
				if (e.index == 0) { 
					mui.openWindow({
								id: "reg",
								url: "login/reg_info.html"
							});
				}
				})
				return false;
			} 
			/*判空操作*/
			if (isserverlog == null) {
				plus.storage.setItem('isServerlogin', 0);
			}
			if ((isserverlog != 1) || (isserverlog != "1")) {
				mui.openWindow({
					id: "login",
					url: "login/login.html"
				});
			} else {
				var url = request_url + "get_user_order_state";
				mui.ajax(url, {
					data: {
						"coach_pk": plus.storage.getItem("logincoach_pk")
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 5000, //超时时间设置为5秒；
					success: function(rsp) {
						console.log(rsp.result);
						if(parseInt(rsp.result)==0)  //留单功能
						{
							mui.openWindow({
								id: "graborder_list",
								url: "usercenter/graborder_list.html"
							});
						}
						else
						{
							mui.toast("您有未完成订单，暂不能抢单!");
						}
					}
				});						
			}
//							mui.openWindow({
//								id: "qiangdan",
//								url: "qiangdan.html",
//								extras: {
//									param: "{'Table':[{'RowIndex':'1','order_pk':'b6781b93-9f6a-499c-aa8e-9113a489d651','user_pk':'a31309c3-931d-4a9a-8f05-0280634aecb4','user_name':'小雪','user_tel':'17792513817','user_sms':'0','order_type':'1','order_datetime':'2015-12-18&nbsp;1:24','start_address':'雁塔区太白南路中国移动3G手机销售中心北52米','start_lon':'34.209048','start_lat':'108.907845','end_address':'雁塔区南三环江林公园里东南181米','end_lon':'34.197255','end_lat':'108.914436','order_away':'2.3','order_time':'7','coach_pk':'','car_meal_fee':'0.00','order_away_fee':'0.00','order_time_fee':'0.00','order_far_away_fee':'0.00','order_cut_fee':'0.00','order_fee':'0.00','order_rem':'undefined','order_state':'0','create_time':'2015/12/18&nbsp;1:24:33'}]}"
//								}
//							});
		});
	</script>

</html>
